WITH NOTIF_FILTERED
AS (
	SELECT NSM.*
	FROM NOTIFICATION_SUMMARY_M NSM
	WHERE CASE 
			WHEN NSM.NOTIFICATION_TYPE_CD = 'OCC_ENROLLMENT'
				THEN NSM.AGENT_CD
			ELSE NSM.SERVICING_AGENT_CD
			END = UPPER(:advisorCode)
		AND NSM.NOTIFICATION_TYPE_CD IN (:polServiceListFilter)
	),
POL_CHNG_COMP_AHO_LIST
AS (
	SELECT *
	FROM (
		SELECT CASE 
				WHEN RPML.REQUEST_PAYMENT_METHOD = 'PAY_ACF'
					THEN 1
				WHEN RPML.REQUEST_PAYMENT_METHOD = 'PAY_ACB'
					THEN 2
				WHEN RPML.REQUEST_PAYMENT_METHOD = 'PAY_BANK'
					THEN 3
				WHEN RPML.REQUEST_PAYMENT_METHOD = 'PAY_TT'
					THEN 4
				WHEN RPML.REQUEST_PAYMENT_METHOD = 'PAY_CHQ'
					THEN 5
				WHEN RPML.REQUEST_PAYMENT_METHOD = 'PAY_CREDIT'
					THEN 6
				WHEN RPML.REQUEST_PAYMENT_METHOD = 'PAY_TRAN'
					THEN 7
				WHEN RPML.REQUEST_PAYMENT_METHOD = 'PAY_RD'
					THEN 8
				END AS SORT_ORDER,
			RPML.REQUEST_PAYMENT_METHOD,
			RPML.SOURCE_CURRENCY_CD,
			RPML.REQUEST_PAYMENT_NUM,
			RPML.DISPLAY_REQUEST_PAYMENT_AMT,
			RPML.REQUEST_SUBMISSION_DT,
			RPML.POLICY_AGREEMENT_ID,
			RPML.REQUEST_SUB_TYPE_CD,
			RPML.REQUEST_TYPE_CD,
			NULL AS AGENT_PENDING_ENG_TXT,
			NULL AS AGENT_PENDING_CH_TXT,
			NULL AS REQUEST_LOG_ID,
			NULL AS PENDING_CD,
			NULL AS PENDING_DETAIL
		FROM REQUEST_PAYMENT_METHOD_LOG_M RPML
		WHERE RPML.REQUEST_PAYMENT_METHOD IN ('PAY_ACF', 'PAY_ACB', 'PAY_BANK', 'PAY_TT', 'PAY_CHQ', 'PAY_CREDIT', 'PAY_TRAN', 'PAY_RD')
			AND (
				(
					RPML.REQUEST_TYPE_CD = 'FUND'
					AND RPML.REQUEST_SUB_TYPE_CD = 'AUTOWIT'
					)
				OR (
					RPML.REQUEST_TYPE_CD = 'VALUE'
					AND RPML.REQUEST_SUB_TYPE_CD IN ('CASHDIV', 'CPAYOUT', 'DMTMBONUS', 'MATURE')
					)
				OR (
					RPML.REQUEST_TYPE_CD = 'CHGFIN'
					AND RPML.REQUEST_SUB_TYPE_CD = 'MEDCOUPON'
					)
				)
		
		UNION ALL
		
		SELECT NULL AS SORT_ORDER,
			NULL AS REQUEST_PAYMENT_METHOD,
			NULL AS SOURCE_CURRENCY_CD,
			NULL AS REQUEST_PAYMENT_NUM,
			NULL AS DISPLAY_REQUEST_PAYMENT_AMT,
			NULL AS REQUEST_SUBMISSION_DT,
			NULL AS POLICY_AGREEMENT_ID,
			NULL AS REQUEST_SUB_TYPE_CD,
			NULL AS REQUEST_TYPE_CD,
			LISTAGG(NVL(RPLT.AGENT_PENDING_ENG_TXT, ' '), '||') WITHIN
		GROUP (
				ORDER BY RPLT.PENDING_CD,
					RPLT.AGENT_PENDING_ENG_TXT
				) OVER (PARTITION BY RPLT.REQUEST_LOG_ID) AGENT_PENDING_ENG_TXT,
			LISTAGG(NVL(TO_CHAR(RPLT.AGENT_PENDING_CHN_TXT), ' '), '||') WITHIN
		GROUP (
				ORDER BY RPLT.PENDING_CD,
					RPLT.AGENT_PENDING_CHN_TXT
				) OVER (PARTITION BY RPLT.REQUEST_LOG_ID) AGENT_PENDING_CH_TXT,
			RPLT.REQUEST_LOG_ID,
			RPLT.PENDING_CD AS PENDING_CD,
			LISTAGG(NVL(TO_CHAR(RPLT.PENDING_DETAIL), ' '), '||') WITHIN
		GROUP (
				ORDER BY RPLT.PENDING_CD,
					RPLT.AGENT_PENDING_ENG_TXT,
					RPLT.AGENT_PENDING_CHN_TXT
				) OVER (PARTITION BY RPLT.REQUEST_LOG_ID) PENDING_DETAIL
		FROM NOTIF_FILTERED NST
		INNER JOIN REQUEST_LOG_M RLT
			ON NST.NOTIFICATION_ID = RLT.REQUEST_LOG_ID
		LEFT JOIN REQUEST_PENDING_LOG_M RPLT
			ON NST.NOTIFICATION_ID = RPLT.REQUEST_LOG_ID
		WHERE RPLT.PENDING_STATUS_CD = 'PE_INCOM'
			AND RPLT.AGENT_PENDING_ENG_TXT NOT IN ('NA', 'N/A')
			AND RLT.REQUEST_STATUS_CD IN ('FILECL', 'CANCEL')
		)
	ORDER BY PENDING_CD
	),
OCC_ENROLLMENT
AS (
	SELECT DISTINCT TO_CHAR(NST.NOTIFICATION_ID) AS UNIQUE_ID,
		TO_CHAR(NST.START_DTTM, 'DD-Mon-YYYY') AS NOTIFICATION_DATE,
		NST.NOTIFICATION_TYPE_CD AS NOTIFICATION_TYPE,
		NULL AS CLIENT_NAME_EN,
		NULL AS CLIENT_NAME_CH,
		NULL AS CLIENT_ID,
		NULL AS POLICY_NUM,
		NULL AS PLAN_NAME_EN,
		NULL AS PLAN_NAME_CH,
		NULL AS INSURED_NAME_EN,
		NULL AS INSURED_NAME_CH,
		NULL AS SETUP_REJECT_DATE,
		NULL AS REJECTED_ACCOUNT_NUM,
		NULL AS REJECT_REASON,
		NULL AS REQUEST_TYPE_CODE,
		NULL AS REQUEST_SUB_TYPE_CODE,
		NULL AS IS_ESERVICE,
		NULL AS PENDING_REQUIREMENT_COUNT,
		NULL AS MAX_UPDATE_DATE,
		NULL AS DEADLINE_DATE,
		NULL AS REQUEST_ID,
		NULL AS REQUEST_STATUS_CODE,
		NULL AS REQUEST_REJECT_REASON_EN,
		NULL AS REQUEST_REJECT_REASON_CH,
		NULL AS ADDRESS_CHANGE_DT,
		NULL AS NOTIFICATION_ID,
		NULL AS NOTIF_ORDER,
		NULL AS IS_INFORCED,
		NULL AS HAS_FUNDS,
		NULL AS HAS_PVAL,
		NULL AS OPT_OUT_REASON_CD,
		NULL AS PAYMENT_CURRENCY_EN,
		NULL AS PAYMENT_CURRENCY_CH,
		NULL AS PAYMENT_AMOUNT,
		NULL AS BILLING_DATE,
		NULL AS LOAN_AMOUNT,
		NULL AS LOAN_EFFECTIVE_DATE,
		NULL AS PAYMENT_METHOD_LIST,
		NULL AS CURRENCY_LIST,
		NULL AS POLICY_NO_LIST,
		NULL AS AMOUNT_LIST,
		NULL AS PREMIUM_DUE_DATE,
		NULL AS PENDING_DETAIL,
		NULL AS PROJECTED_PREMIUM
	FROM NOTIF_FILTERED NST
	WHERE NST.NOTIFICATION_TYPE_CD = 'OCC_ENROLLMENT'
		AND TO_CHAR(NST.NOTIFICATION_ID) = :occEnrollmentEligibilityId
	),
DDA_SETUP_AUTO_PAY_REJECT_LIST
AS (
	SELECT DISTINCT CASE 
			WHEN NST.NOTIFICATION_TYPE_CD = 'DDA_SREJ'
				THEN NST.POLICY_NUM
			WHEN NST.NOTIFICATION_TYPE_CD = 'AUTOPAY_REJECT_AHO'
				THEN TO_CHAR(NST.NOTIFICATION_SUMMARY_ID)
			END AS UNIQUE_ID,
		TO_CHAR(NST.START_DTTM, 'DD-Mon-YYYY') AS NOTIFICATION_DATE,
		NST.NOTIFICATION_TYPE_CD AS NOTIFICATION_TYPE,
		CST.FULL_NAME_EN AS CLIENT_NAME_EN,
		CST.FULL_NAME_CH AS CLIENT_NAME_CH,
		NST.OWNER_CLIENT_ID AS CLIENT_ID,
		NST.POLICY_NUM AS POLICY_NUM,
		PT.PLAN_ENG_NAME AS PLAN_NAME_EN,
		PT.PLAN_CHN_NAME AS PLAN_NAME_CH,
		PIT.FULL_NAME_EN AS INSURED_NAME_EN,
		PIT.FULL_NAME_CH AS INSURED_NAME_CH,
		CASE 
			WHEN NOTIFICATION_TYPE_CD = 'DDA_SREJ'
				THEN TO_CHAR(NST.KEY_DT, 'DD-Mon-YYYY')
			ELSE TO_CHAR(NVL(DBTM.DDA_TRANSACTION_DT, CCTM.CREDIT_CARD_TRANSACTION_DT), 'DD-Mon-YYYY')
			END AS SETUP_REJECT_DATE,
		CASE 
			WHEN NOTIFICATION_TYPE_CD = 'DDA_SREJ'
				THEN PRT.BANK_ACCOUNT_NUM
			ELSE CASE 
					WHEN DBTM.BANK_ACCT_NUM IS NOT NULL
						THEN DBTM.BANK_CD || '-' || DBTM.BANK_BRANCH_CD || '-' || DBTM.BANK_ACCT_NUM
					ELSE CCTM.CREDIT_CARD_NUM
					END
			END AS REJECTED_ACCOUNT_NUM,
		CASE 
			WHEN NOTIFICATION_TYPE_CD = 'DDA_SREJ'
				THEN PRT.DIRECT_DEBIT_CONFIRM_CD
			ELSE NVL(DBTM.DDA_REJECT_REASON_CD, CCTM.CREDIT_CARD_COLLECT_BANK_CD || '-' || CCTM.BANK_REJECT_REASON_CD)
			END AS REJECT_REASON,
		NULL AS REQUEST_TYPE_CODE,
		NULL AS REQUEST_SUB_TYPE_CODE,
		NULL AS IS_ESERVICE,
		NULL AS PENDING_REQUIREMENT_COUNT,
		NULL AS MAX_UPDATE_DATE,
		NULL AS DEADLINE_DATE,
		NULL AS REQUEST_ID,
		NULL AS REQUEST_STATUS_CODE,
		NULL AS REQUEST_REJECT_REASON_EN,
		NULL AS REQUEST_REJECT_REASON_CH,
		NULL AS ADDRESS_CHANGE_DT,
		NULL AS NOTIFICATION_ID,
		CASE 
			WHEN NST.NOTIFICATION_TYPE_CD = 'DDA_SREJ'
				THEN 4
			WHEN NST.NOTIFICATION_TYPE_CD = 'AUTOPAY_REJECT_AHO'
				THEN 5
			END AS NOTIF_ORDER,
		NULL AS IS_INFORCED,
		NULL AS HAS_FUNDS,
		NULL AS HAS_PVAL,
		NULL AS OPT_OUT_REASON_CD,
		NULL AS PAYMENT_CURRENCY_EN,
		NULL AS PAYMENT_CURRENCY_CH,
		NULL AS PAYMENT_AMOUNT,
		NULL AS BILLING_DATE,
		NULL AS LOAN_AMOUNT,
		NULL AS LOAN_EFFECTIVE_DATE,
		NULL AS PAYMENT_METHOD_LIST,
		NULL AS CURRENCY_LIST,
		NULL AS POLICY_NO_LIST,
		NULL AS AMOUNT_LIST,
		CASE 
			WHEN NST.NOTIFICATION_TYPE_CD = 'AUTOPAY_REJECT_AHO'
				THEN NVL(DBTM.PREMIUM_DUE_DT, CCTM.PREMIUM_DUE_DT)
			ELSE NULL
			END AS PREMIUM_DUE_DATE,
		NULL AS PENDING_DETAIL,
		NULL AS PROJECTED_PREMIUM
	FROM NOTIF_FILTERED NST
	INNER JOIN CLIENT_SEARCH_M CST
		ON NST.OWNER_CLIENT_ID = CST.CLIENT_ID
	INNER JOIN POLICY_M PT
		ON NST.POLICY_AGREEMENT_ID = PT.POLICY_AGREEMENT_ID
	INNER JOIN POLICY_INSURED_M PIT
		ON NST.INSURED_CLIENT_ID = PIT.CLIENT_ID
	INNER JOIN POLICY_ROLE_M PRT
		ON NST.POLICY_AGREEMENT_ID = PRT.POLICY_AGREEMENT_ID
	LEFT JOIN DIRECT_DEBIT_TRANSACTION_M DBTM
		ON DBTM.DDA_TRANSACTION_ID = NST.NOTIFICATION_ID
			AND DBTM.POLICY_NUM = NST.POLICY_NUM
			AND NST.NOTIFICATION_TYPE_CD = 'AUTOPAY_REJECT_AHO'
	LEFT JOIN CREDIT_CARD_TRANSACTION_M CCTM
		ON CCTM.CREDIT_CARD_TRANSACTION_ID = NST.NOTIFICATION_ID
			AND CCTM.POLICY_NUM = NST.POLICY_NUM
			AND NST.NOTIFICATION_TYPE_CD = 'AUTOPAY_REJECT_AHO'
	WHERE NST.NOTIFICATION_TYPE_CD IN ('DDA_SREJ', 'AUTOPAY_REJECT_AHO')
		AND NST.KEY_DT = CASE 
			WHEN NST.NOTIFICATION_TYPE_CD = 'DDA_SREJ'
				THEN PRT.DIRECT_DEBIT_CONFIRM_DT
			ELSE NST.KEY_DT
			END
		AND NST.KEY_DT > = CASE 
			WHEN NST.NOTIFICATION_TYPE_CD = 'DDA_SREJ'
				THEN (SYSDATE - 60)
			ELSE NST.KEY_DT
			END
	),
POLICY_CHANGE_LIST
AS (
	SELECT DISTINCT TO_CHAR(NST.NOTIFICATION_ID) AS UNIQUE_ID,
		TO_CHAR(NST.START_DTTM, 'DD-Mon-YYYY') AS NOTIFICATION_DATE,
		NST.NOTIFICATION_TYPE_CD AS NOTIFICATION_TYPE,
		CST.FULL_NAME_EN AS CLIENT_NAME_EN,
		CST.FULL_NAME_CH AS CLIENT_NAME_CH,
		NST.OWNER_CLIENT_ID AS CLIENT_ID,
		NST.POLICY_NUM AS POLICY_NUM,
		PT.PLAN_ENG_NAME AS PLAN_NAME_EN,
		PT.PLAN_CHN_NAME AS PLAN_NAME_CH,
		PIT.FULL_NAME_EN AS INSURED_NAME_EN,
		PIT.FULL_NAME_CH AS INSURED_NAME_CH,
		NULL AS SETUP_REJECT_DATE,
		NULL AS REJECTED_ACCOUNT_NUM,
		NULL AS REJECT_REASON,
		RLT.REQUEST_TYPE_CD AS REQUEST_TYPE_CODE,
		RLT.REQUEST_SUB_TYPE_CD AS REQUEST_SUB_TYPE_CODE,
		CASE 
			WHEN RLT.EREFERENCE_NUM IS NULL
				THEN 0
			ELSE 1
			END AS IS_ESERVICE,
		CASE 
			WHEN NST.NOTIFICATION_TYPE_CD = 'POLICY_CHANGE_PENDING_AHO'
				THEN NST.CASE_COUNT
			ELSE NULL
			END AS PENDING_REQUIREMENT_COUNT,
		CASE 
			WHEN NST.NOTIFICATION_TYPE_CD = 'POLICY_CHANGE_PENDING_AHO'
				THEN TO_CHAR((
							SELECT MAX(RPL.UPDATE_DTTM)
							FROM REQUEST_PENDING_LOG_M RPL
							WHERE NST.NOTIFICATION_ID = RPL.REQUEST_LOG_ID
							), 'DD Mon, YYYY')
			ELSE NULL
			END AS MAX_UPDATE_DATE,
		CASE 
			WHEN NST.NOTIFICATION_TYPE_CD = 'POLICY_CHANGE_PENDING_AHO'
				THEN TO_CHAR(RLT.LAST_DEADLINE_DT, 'DD Mon, YYYY')
			ELSE NULL
			END AS DEADLINE_DATE,
		CASE 
			WHEN NST.NOTIFICATION_TYPE_CD = 'POLICY_CHANGE_PENDING_AHO'
				THEN RLT.REQUEST_LOG_ID
			ELSE NULL
			END AS REQUEST_ID,
		CASE 
			WHEN NST.NOTIFICATION_TYPE_CD = 'POLICY_CHANGE_COMPLETE_AHO'
				THEN RLT.REQUEST_STATUS_CD
			ELSE NULL
			END AS REQUEST_STATUS_CODE,
		CASE 
			WHEN NST.NOTIFICATION_TYPE_CD = 'POLICY_CHANGE_COMPLETE_AHO'
				THEN RRL.AGENT_PENDING_ENG_TXT
			ELSE NULL
			END AS REQUEST_REJECT_REASON_EN,
		CASE 
			WHEN NST.NOTIFICATION_TYPE_CD = 'POLICY_CHANGE_COMPLETE_AHO'
				THEN RRL.AGENT_PENDING_CH_TXT
			ELSE NULL
			END AS REQUEST_REJECT_REASON_CH,
		NULL AS ADDRESS_CHANGE_DT,
		NULL AS NOTIFICATION_ID,
		CASE 
			WHEN NST.NOTIFICATION_TYPE_CD = 'POLICY_CHANGE_PENDING_AHO'
				THEN 2
			WHEN NST.NOTIFICATION_TYPE_CD = 'POLICY_CHANGE_COMPLETE_AHO'
				THEN 3
			END AS NOTIF_ORDER,
		NULL AS IS_INFORCED,
		NULL AS HAS_FUNDS,
		NULL AS HAS_PVAL,
		NULL AS OPT_OUT_REASON_CD,
		NULL AS PAYMENT_CURRENCY_EN,
		NULL AS PAYMENT_CURRENCY_CH,
		NULL AS PAYMENT_AMOUNT,
		NULL AS BILLING_DATE,
		NULL AS LOAN_AMOUNT,
		NULL AS LOAN_EFFECTIVE_DATE,
		PAYMENT_METHOD_LIST AS PAYMENT_METHOD_LIST,
		CURRENCY_LIST AS CURRENCY_LIST,
		POLICY_NO_LIST AS POLICY_NO_LIST,
		AMOUNT_LIST AS AMOUNT_LIST,
		NULL AS PREMIUM_DUE_DATE,
		RRL.PENDING_DETAIL,
		NULL AS PROJECTED_PREMIUM
	FROM NOTIF_FILTERED NST
	INNER JOIN CLIENT_SEARCH_M CST
		ON NST.OWNER_CLIENT_ID = CST.CLIENT_ID
	INNER JOIN POLICY_M PT
		ON NST.POLICY_AGREEMENT_ID = PT.POLICY_AGREEMENT_ID
	INNER JOIN POLICY_INSURED_M PIT
		ON NST.INSURED_CLIENT_ID = PIT.CLIENT_ID
	INNER JOIN REQUEST_LOG_M RLT
		ON NST.NOTIFICATION_ID = RLT.REQUEST_LOG_ID
	LEFT JOIN REQUEST_PENDING_LOG_M RPLT
		ON NST.NOTIFICATION_ID = RPLT.REQUEST_LOG_ID
	LEFT JOIN (
		SELECT LISTAGG(PDL.REQUEST_PAYMENT_METHOD, ',') WITHIN
		GROUP (
				ORDER BY PDL.SORT_ORDER,
					PDL.SOURCE_CURRENCY_CD,
					PDL.DISPLAY_REQUEST_PAYMENT_AMT,
					PDL.REQUEST_PAYMENT_NUM
				) PAYMENT_METHOD_LIST,
			LISTAGG(PDL.SOURCE_CURRENCY_CD, ',') WITHIN
		GROUP (
				ORDER BY PDL.SORT_ORDER,
					PDL.SOURCE_CURRENCY_CD,
					PDL.DISPLAY_REQUEST_PAYMENT_AMT,
					PDL.REQUEST_PAYMENT_NUM
				) CURRENCY_LIST,
			LISTAGG(NVL(PDL.REQUEST_PAYMENT_NUM, '0'), ',') WITHIN
		GROUP (
				ORDER BY PDL.SORT_ORDER,
					PDL.SOURCE_CURRENCY_CD,
					PDL.DISPLAY_REQUEST_PAYMENT_AMT,
					PDL.REQUEST_PAYMENT_NUM
				) POLICY_NO_LIST,
			LISTAGG(PDL.DISPLAY_REQUEST_PAYMENT_AMT, ',') WITHIN
		GROUP (
				ORDER BY PDL.SORT_ORDER,
					PDL.SOURCE_CURRENCY_CD,
					PDL.DISPLAY_REQUEST_PAYMENT_AMT,
					PDL.REQUEST_PAYMENT_NUM
				) AMOUNT_LIST,
			PDL.REQUEST_SUB_TYPE_CD,
			PDL.REQUEST_TYPE_CD,
			PDL.REQUEST_SUBMISSION_DT,
			PDL.POLICY_AGREEMENT_ID
		FROM POL_CHNG_COMP_AHO_LIST PDL
		GROUP BY PDL.REQUEST_SUBMISSION_DT,
			PDL.REQUEST_TYPE_CD,
			PDL.REQUEST_SUB_TYPE_CD,
			PDL.POLICY_AGREEMENT_ID
		) RPMLT
		ON RPMLT.POLICY_AGREEMENT_ID = RLT.POLICY_AGREEMENT_ID
			AND RPMLT.REQUEST_SUBMISSION_DT = RLT.REQUEST_SUBMISSION_DT
			AND RPMLT.REQUEST_TYPE_CD = RLT.REQUEST_TYPE_CD
			AND RPMLT.REQUEST_SUB_TYPE_CD = RLT.REQUEST_SUB_TYPE_CD
			AND RLT.REQUEST_STATUS_CD = 'COMP'
	LEFT JOIN POL_CHNG_COMP_AHO_LIST RRL
		ON RRL.REQUEST_LOG_ID = RPLT.REQUEST_LOG_ID
	WHERE NST.NOTIFICATION_TYPE_CD IN ('POLICY_CHANGE_PENDING_AHO', 'POLICY_CHANGE_COMPLETE_AHO')
	),
POLICY_CHANGE_PHASE_2_3_LIST
AS (
	SELECT DISTINCT TO_CHAR(NSM.NOTIFICATION_SUMMARY_ID) AS UNIQUE_ID,
		TO_CHAR(NSM.START_DTTM, 'DD-Mon-YYYY') AS NOTIFICATION_DATE,
		NSM.NOTIFICATION_TYPE_CD AS NOTIFICATION_TYPE,
		CSM.FULL_NAME_EN AS CLIENT_NAME_EN,
		CSM.FULL_NAME_CH AS CLIENT_NAME_CH,
		NSM.OWNER_CLIENT_ID AS CLIENT_ID,
		NSM.POLICY_NUM AS POLICY_NUM,
		PM.PLAN_ENG_NAME AS PLAN_NAME_EN,
		PM.PLAN_CHN_NAME AS PLAN_NAME_CH,
		PIM.FULL_NAME_EN AS INSURED_NAME_EN,
		PIM.FULL_NAME_CH AS INSURED_NAME_CH,
		NULL AS SETUP_REJECT_DATE,
		NULL AS REJECTED_ACCOUNT_NUM,
		NULL AS REJECT_REASON,
		NULL AS REQUEST_TYPE_CODE,
		NULL AS REQUEST_SUB_TYPE_CODE,
		NULL AS IS_ESERVICE,
		NULL AS PENDING_REQUIREMENT_COUNT,
		NULL AS MAX_UPDATE_DATE,
		NULL AS DEADLINE_DATE,
		NULL AS REQUEST_ID,
		NULL AS REQUEST_STATUS_CODE,
		NULL AS REQUEST_REJECT_REASON_EN,
		NULL AS REQUEST_REJECT_REASON_CH,
		TO_CHAR(GAM.ADDRESS_CHANGE_DT, 'DD Mon, YYYY') AS ADDRESS_CHANGE_DT,
		NSM.NOTIFICATION_ID AS NOTIFICATION_ID,
		CASE 
			WHEN NSM.NOTIFICATION_TYPE_CD = 'UNIT_LINKED_BILLING_AHO'
				THEN 6
			WHEN NSM.NOTIFICATION_TYPE_CD = 'APL_PROCESSED_AHO'
				THEN 7
			WHEN NSM.NOTIFICATION_TYPE_CD = 'LOAN_REPAYMENT_AHO'
				THEN 8
			WHEN NSM.NOTIFICATION_TYPE_CD = 'ERROR_ADDRESS_AHO'
				THEN 9
			WHEN NSM.NOTIFICATION_TYPE_CD = 'MEDICAL_UPGRADE_AHO'
				THEN 10
			END AS NOTIF_ORDER,
		CASE 
			WHEN PM.POLICY_STATUS_CD IN ('1', '2', '3', '4')
				THEN 1
			ELSE 0
			END AS IS_INFORCED,
		CASE 
			WHEN PM.POLICY_TYPE_TAG_CD = 'E'
				THEN 1
			ELSE 0
			END AS HAS_FUNDS,
		PVD.HAS_PVAL,
		NULL AS OPT_OUT_REASON_CD,
		PM.CURRENCY_ENG_TXT AS PAYMENT_CURRENCY_EN,
		PM.CURRENCY_CHN_TXT AS PAYMENT_CURRENCY_CH,
		PM.SUNDRY_PAYMENT_AMT AS PAYMENT_AMOUNT,
		PM.POLICY_BILL_TO_DT AS BILLING_DATE,
		LHM.POLICY_LOAN_TRXN_AMT AS LOAN_AMOUNT,
		LHM.POLICY_LOAN_EFF_DT AS LOAN_EFFECTIVE_DATE,
		NULL AS PAYMENT_METHOD_LIST,
		NULL AS CURRENCY_LIST,
		NULL AS POLICY_NO_LIST,
		NULL AS AMOUNT_LIST,
		NULL AS PREMIUM_DUE_DATE,
		NULL AS PENDING_DETAIL,
		NULL AS PROJECTED_PREMIUM
	FROM NOTIF_FILTERED NSM
	INNER JOIN CLIENT_SEARCH_M CSM
		ON NSM.POLICY_AGREEMENT_ID = CSM.POLICY_AGREEMENT_ID
			AND NSM.OWNER_PARTY_ID = CSM.PARTY_ID
	INNER JOIN POLICY_M PM
		ON NSM.POLICY_AGREEMENT_ID = PM.POLICY_AGREEMENT_ID
	INNER JOIN POLICY_INSURED_M PIM
		ON NSM.INSURED_PARTY_ID = PIM.PARTY_ID
			AND NSM.POLICY_AGREEMENT_ID = PIM.POLICY_AGREEMENT_ID
	LEFT JOIN GEOGRAPHY_ADDRESS_M GAM
		ON NSM.NOTIFICATION_ID = GAM.ADDRESS_ID
	LEFT JOIN LOAN_HISTORY_M LHM
		ON LHM.LOAN_HISTORY_ID = NSM.NOTIFICATION_ID
			AND NSM.POLICY_NUM = LHM.POLICY_NUM
	OUTER APPLY (
		SELECT CASE 
				WHEN COUNT(*) = 1
					THEN 1
				ELSE 0
				END AS HAS_PVAL
		FROM POLICY_VALUE_DISPLAY_M
		WHERE POLICY_AGREEMENT_ID = PM.POLICY_AGREEMENT_ID
			AND PLAN_ATR_ID IN (1, 24, 29, 41, 42, 45)
			AND ROWNUM = 1
		) PVD
	WHERE NOTIFICATION_TYPE_CD IN ('ERROR_ADDRESS_AHO', 'UNIT_LINKED_BILLING_AHO', 'APL_PROCESSED_AHO', 'LOAN_REPAYMENT_AHO', 'MEDICAL_UPGRADE_AHO')
	),
OPT_OUT_CLIENT_EADVICE_LIST
AS (
	SELECT DISTINCT CASE 
			WHEN NSM.NOTIFICATION_TYPE_CD IN ('GO_GREEN_EMAIL_ERROR_AHO', 'GO_GREEN_EMAIL_ERROR_REMINDER_AHO')
				THEN TO_CHAR(NSM.OWNER_CLIENT_ID)
			WHEN NSM.NOTIFICATION_TYPE_CD = 'OPT_OUT_CLIENT_AHO'
				THEN TO_CHAR(NSM.NOTIFICATION_SUMMARY_ID)
			END AS UNIQUE_ID,
		TO_CHAR(NSM.START_DTTM, 'DD-Mon-YYYY') AS NOTIFICATION_DATE,
		NSM.NOTIFICATION_TYPE_CD AS NOTIFICATION_TYPE,
		CSM.FULL_NAME_EN AS CLIENT_NAME_EN,
		CSM.FULL_NAME_CH AS CLIENT_NAME_CH,
		NSM.OWNER_CLIENT_ID AS CLIENT_ID,
		NULL AS POLICY_NUM,
		NULL AS PLAN_NAME_EN,
		NULL AS PLAN_NAME_CH,
		NULL AS INSURED_NAME_EN,
		NULL AS INSURED_NAME_CH,
		NULL AS SETUP_REJECT_DATE,
		NULL AS REJECTED_ACCOUNT_NUM,
		NULL AS REJECT_REASON,
		NULL AS REQUEST_TYPE_CODE,
		NULL AS REQUEST_SUB_TYPE_CODE,
		NULL AS IS_ESERVICE,
		NULL AS PENDING_REQUIREMENT_COUNT,
		NULL AS MAX_UPDATE_DATE,
		NULL AS DEADLINE_DATE,
		NULL AS REQUEST_ID,
		NULL AS REQUEST_STATUS_CODE,
		NULL AS REQUEST_REJECT_REASON_EN,
		NULL AS REQUEST_REJECT_REASON_CH,
		NULL AS ADDRESS_CHANGE_DT,
		NULL AS NOTIFICATION_ID,
		CASE 
			WHEN NSM.NOTIFICATION_TYPE_CD IN ('GO_GREEN_EMAIL_ERROR_AHO', 'GO_GREEN_EMAIL_ERROR_REMINDER_AHO')
				THEN 1
			WHEN NSM.NOTIFICATION_TYPE_CD = 'OPT_OUT_CLIENT_AHO'
				THEN 10
			END AS NOTIF_ORDER,
		NULL AS IS_INFORCED,
		NULL AS HAS_FUNDS,
		NULL AS HAS_PVAL,
		NVL(IM.OPT_OUT_REASON_CD, OM.OPT_OUT_REASON_CD) AS OPT_OUT_REASON_CD,
		NULL AS PAYMENT_CURRENCY_EN,
		NULL AS PAYMENT_CURRENCY_CH,
		NULL AS PAYMENT_AMOUNT,
		NULL AS BILLING_DATE,
		NULL AS LOAN_AMOUNT,
		NULL AS LOAN_EFFECTIVE_DATE,
		NULL AS PAYMENT_METHOD_LIST,
		NULL AS CURRENCY_LIST,
		NULL AS POLICY_NO_LIST,
		NULL AS AMOUNT_LIST,
		NULL AS PREMIUM_DUE_DATE,
		NULL AS PENDING_DETAIL,
		NULL AS PROJECTED_PREMIUM,
		ROW_NUMBER() OVER (
			PARTITION BY NSM.OWNER_CLIENT_ID,
			NSM.SERVICING_AGENT_CD ORDER BY NSM.START_DTTM DESC
			) AS SEQ
	FROM NOTIF_FILTERED NSM
	INNER JOIN CLIENT_SEARCH_M CSM
		ON NSM.OWNER_PARTY_ID = CSM.PARTY_ID
	LEFT JOIN INDIVIDUAL_M IM
		ON NSM.OWNER_PARTY_ID = IM.PARTY_ID
	LEFT JOIN ORGANIZATION_M OM
		ON NSM.OWNER_PARTY_ID = OM.PARTY_ID
	WHERE NOTIFICATION_TYPE_CD IN ('GO_GREEN_EMAIL_ERROR_AHO', 'GO_GREEN_EMAIL_ERROR_REMINDER_AHO', 'OPT_OUT_CLIENT_AHO')
	),
F_OPT_OUT_CLIENT_EADVICE_LIST
AS (
	SELECT UNIQUE_ID,
		NOTIFICATION_DATE,
		NOTIFICATION_TYPE,
		CLIENT_NAME_EN,
		CLIENT_NAME_CH,
		CLIENT_ID,
		POLICY_NUM,
		PLAN_NAME_EN,
		PLAN_NAME_CH,
		INSURED_NAME_EN,
		INSURED_NAME_CH,
		SETUP_REJECT_DATE,
		REJECTED_ACCOUNT_NUM,
		REJECT_REASON,
		REQUEST_TYPE_CODE,
		REQUEST_SUB_TYPE_CODE,
		IS_ESERVICE,
		PENDING_REQUIREMENT_COUNT,
		MAX_UPDATE_DATE,
		DEADLINE_DATE,
		REQUEST_ID,
		REQUEST_STATUS_CODE,
		REQUEST_REJECT_REASON_EN,
		REQUEST_REJECT_REASON_CH,
		ADDRESS_CHANGE_DT,
		NOTIFICATION_ID,
		NOTIF_ORDER,
		IS_INFORCED,
		HAS_FUNDS,
		HAS_PVAL,
		OPT_OUT_REASON_CD,
		PAYMENT_CURRENCY_EN,
		PAYMENT_CURRENCY_CH,
		PAYMENT_AMOUNT,
		BILLING_DATE,
		LOAN_AMOUNT,
		LOAN_EFFECTIVE_DATE,
		PAYMENT_METHOD_LIST,
		CURRENCY_LIST,
		POLICY_NO_LIST,
		AMOUNT_LIST,
		PREMIUM_DUE_DATE,
		PENDING_DETAIL,
		PROJECTED_PREMIUM
	FROM OPT_OUT_CLIENT_EADVICE_LIST
	WHERE SEQ = 1
	),
POLICY_SERVICE_LIST
AS (
	SELECT DSAPRL.*
	FROM DDA_SETUP_AUTO_PAY_REJECT_LIST DSAPRL
	
	UNION ALL
	
	SELECT PCL.*
	FROM POLICY_CHANGE_LIST PCL
	
	UNION ALL
	
	SELECT PCPL.*
	FROM POLICY_CHANGE_PHASE_2_3_LIST PCPL
	
	UNION ALL
	
	SELECT OOCEL.*
	FROM F_OPT_OUT_CLIENT_EADVICE_LIST OOCEL
	),
SORTED_POLICY_SERVICE_LIST
AS (
	SELECT PSL.*
	FROM POLICY_SERVICE_LIST PSL
	ORDER BY TO_DATE(PSL.NOTIFICATION_DATE, 'DD-MON-YYYY') DESC,
		PSL.NOTIF_ORDER ASC,
		PSL.CLIENT_NAME_EN ASC,
		PSL.POLICY_NUM ASC,
		CASE 
			WHEN PSL.NOTIFICATION_TYPE = 'AUTOPAY_REJECT_AHO'
				THEN TO_DATE(PSL.SETUP_REJECT_DATE, 'DD-MON-YYYY')
			END DESC,
		CASE 
			WHEN PSL.NOTIFICATION_TYPE = 'AUTOPAY_REJECT_AHO'
				THEN PSL.PREMIUM_DUE_DATE
			END DESC
	)
SELECT OE.*
FROM OCC_ENROLLMENT OE

UNION ALL

SELECT SPSL.*
FROM SORTED_POLICY_SERVICE_LIST SPSL
